
# dbt Project

## Overview

Within the project we have the following file structure:

```plaintext
bay_wheels/
├── dbt_project.yml
└── analyses/
└── seeds/
└── macros/
└── models/
    ├── core/
    │   ├── dim_bay_area_county.sql
    │   ├── dim_stations.sql
    │   ├── facts_baywheels_trips.sql
    │   └── schema.yml
    └── staging/
        ├── stg_baywheels_trips.sql
        └── schema.yaml
```

## Setttin Up

The "dbt_project.yml" file contains the dbt configuration. The project name was set to "de_zoomcamp_bay_wheels".

In addition, two models are defined: "staging" and "core." Views are defined in the staging model, while dimension and fact tables are defined in the "core" model.

```yaml
name: 'de_zoomcamp_bay_wheels'
version: '1.0.0'
config-version: 2

# This setting configures which "profile" dbt uses for this project.
profile: 'default'

model-paths: ["models"]
analysis-paths: ["analyses"]
test-paths: ["tests"]
seed-paths: ["seeds"]
macro-paths: ["macros"]
snapshot-paths: ["snapshots"]

target-path: "target"  # directory which will store compiled SQL files
clean-targets:         # directories to be removed by `dbt clean`
  - "target"
  - "dbt_packages"

models:
  bay_wheels:
    # Applies to all files under models/staging/
    staging:
      +materialized: view
    core:
      +materialized: table


vars:
  is_test_run: false
```

## Raw Tables

To perform transformations with dbt, we start from the raw tables stored in the BigQuery data warehouse. The following describes raw tables in BigQuery.

### Table: bay_area_county_ext 
The data from the San Francisco Bay Area counties dataset is loaded into the external table bay_area_county_ext. This table has the following fields:

* **geometry**. String with Geometric figure that delimits the area of ​​a county in the San Francisco Bay Area.
* **county_id**. Unique identifier.
* **fipsstco**. The Federal Information Processing Standard Publication.
* **county_name**. County name.

### Table: baywheels_tripdata
Bay Wheels bike trip data is loaded into the "baywheels_tripdata" table. This table has the following fields:

* **unique_row_id**. A unique identifier for the trip, generated by hashing key trip attributes.
* **filename**. The source filename from which the trip data was loaded.
* **ride_id**. Ride Identifier.
* **rideable_type**. Ride Type. This field is of categorical type and has the following values: *classic_bike*, *electric_bike* or *electric_escooter*.
* **started_at**. The started date and time.
* **ended_at**. The end date and time.
* **start_station_name**. Start Station Name.
* **start_station_id**. Start Station identifier.
* **end_station_name**. End Station Name.
* **end_station_id**. End Station identifier.
* **start_lat**. Start latitude of the bike trip.
* **start_lng**. Start Longitude of the bike trip.
* **end_lat**. End latitude of the bike trip.
* **end_lng**. End Longitude of the bike trip.
* **member_casual**. User Type. This field is of categorical type and has the following values: *Member* or *Casual*.

## Models

### Staging

In the staging model we define the raw tables "bay_area_county_ext" and "baywheels_tripdata".

```yaml
version: 2

sources:
  - name: staging
    database: "{{ env_var('DBT_DATABASE', 'zoomcamp-de-452200') }}"
    #database: zoomcamp-de-452200
    schema: "{{ env_var('DBT_SCHEMA', 'bike_data_all') }}"
    tables:
      - name: bay_area_county_ext
      - name: baywheels_tripdata
```
The names *DBT_DATABASE* and *DBT_SCHEMA* define environment variables that reference GCP Project ID and dataset in Bigquery respectively.

#### View: stg_baywheels_trips

The "stg_baywheels_trips" view is constructed from the raw "baywheels_tripdata" table. The "stg_baywheels_trips" view contains the following fields:

* **ride_id**. Ride Identifier.
* **rideable_type**. Ride Type. This field is of categorical type and has the following values: *classic_bike*, *electric_bike* or *electric_escooter*.
* **started_at**. The started date and time.
* **ended_at**. The end date and time.
* **duration_min**. Trip duration in minutes.
* **start_station_name**. Start Station Name.
* **start_station_id**. Start Station identifier.
* **end_station_name**. End Station Name.
* **end_station_id**. End Station identifier.
* **start_lat**. Start latitude of the bike trip.
* **start_lng**. Start Longitude of the bike trip.
* **end_lat**. End latitude of the bike trip.
* **end_lng**. End Longitude of the bike trip.
* **member_casual**. User Type. This field is of categorical type and has the following values: *Member* or *Casual*.
* **updated_at**. Trip update date.

### Core

#### Table: dim_bay_area_county

The dimension table "dim_bay_area_county" is created from the raw table "bay_area_county_ext." To create the table, the "geometry" column is transformed from a string to a multipolygon, and the update date is added.

* **county_id**. Unique identifier.
* **county_name**. County name.
* **fipsstco**. The Federal Information Processing Standard Publication.
* **geometry**. Multipolygon that delimits the area of ​​a county in the San Francisco Bay Area.
* **updated_at**. Update date.


#### Table: dim_stations

Unfortunately, a dataset with updated stations was not found for the Bay Wheels dataset. However, the start and end stations (along with their respective longitude and latitude coordinates) of a bike trip are explicitly described within the trip itself. However, upon inspection, it was found that some station locations are incorrect and appear outside the San Francisco Bay Area.

The "dim_stations" table is created by joining the start (start_station_id) and end (end_station_id) stations from the "baywheels_tripdata" table. We join it with the "dim_bay_area_county" table and filter out stations that are not located in a Bay Area county. We group the stations by their station_id to avoid duplicate stations.

* **station_id**. Station id.
* **station_name**. Station Name.
* **location**. Coordinates with the longitude and latitude of the station.
* **updated_at**. Update date.


#### Table: facts_baywheels_trips

The "facts_baywheels_trips" table contains data on Bay Wheels bike trips added monthly. To perform this loading, we use data from the "stg_baywheels_trips" view. Within the trip universe, there may be start and/or end locations very far from the San Francisco Bay Area; we need to map them to prevent them from distorting the trip analysis. To do this, we use the "dim_bay_area_county" table, which contains the county boundaries of the San Francisco Bay Area.

The "facts_baywheels_trips" table contains the following fields:

* **ride_id**. Ride Identifier.
* **rideable_type**. Ride Type. This field is of categorical type and has the following values: *classic_bike*, *electric_bike* or *electric_escooter*.
* **started_at**. The started date and time.
* **ended_at**. The end date and time.
* **duration_min**. Trip duration in minutes.
* **start_loc**. Start coordinates of the bike trip.
* **end_loc**. End coordinates of the bike trip.
* **trajectory**. Route from the start station to the end station.
* **start_station_name**. Start Station Name.
* **start_station_id**. Start Station identifier.
* **end_station_name**. End Station Name.
* **end_station_id**. End Station identifier.
* **start_station_loc**. Start Station coordinates of the bike trip.
* **end_station_loc**. End Station coordinates of the bike trip.
* **hour_of_day**. Hour of the day the trip was made.
* **day_of_week**. Day of the week the trip was made.
* **time_of_day**. Day timw. This field is of categorical type and has the following values: *morning*, *afternoon* and *evening*.
* **pickup_month**. Month the trip was made.
* **pickup_quarter**. Quarter the trip was made.
* **pickup_year**. Year the trip was made.
* **member_casual**. User Type. This field is of categorical type and has the following values: *Member* or *Casual*.
* **distance_km**. Distance traveled in kilometers.


Because bike trip data is added monthly, the data is added to this table incrementally. For this reason, this table will be *incremental*.

Since the analysis we will perform will be based on trips at the day level, the partitioning will be done by the date column *started_at* with a *day* granularity.

Finally, for our analysis, the start station of the trip is very important, which is why the table is clustered by the *start_station_id* column.

The lineage of the transformations to obtain the "facts_baywheels_trips" fact table is shown below.

![image](images/dbt-dag.png)
